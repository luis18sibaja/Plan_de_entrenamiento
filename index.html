<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Entrenamiento Progresivo: 3 Meses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Fuego y Ceniza -->
    <!-- Application Structure Plan: A 3-month progressive plan deserves a more robust structure. I've designed a tab-based navigation for Months 1, 2, and 3. Each month reveals its own weekly plan (3 workout days). This tiered structure organizes a large amount of information intuitively. Day selection reveals the specific workout, now presented in an accordion format (Warm-up, HIIT, Cooldown) to keep the UI clean. This allows the user to focus on one section at a time. I've added smooth transitions and a 'progress bar' for visual feedback on month completion. -->
    <!-- Visualization & Content Choices: Report Info: 3-month progressive exercises -> Goal: Guide user through a long-term plan -> Viz: Tabbed layout for months, accordion for daily sections -> Interaction: Click to switch months/expand sections. Justification: Manages complexity and provides a clear sense of progression. Report Info: Increased exercise complexity -> Goal: Teach more advanced movements -> Viz: High-quality GIFs in modals -> Interaction: Click-to-view. Justification: On-demand visual instruction is crucial for safety and efficacy. Report Info: Overall progress -> Goal: Motivate the user -> Viz: A simple visual progress bar for months -> Interaction: Updates on tab-click. Justification: Reinforces commitment and visualizes the journey. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            scroll-behavior: smooth; 
            background-color: #111827; 
            color: #e5e7eb;
        }
        .tab-active { 
            background-color: #f97316; 
            color: white; 
            box-shadow: 0 5px 20px rgba(249, 115, 22, 0.4);
        }
        .tab-inactive { 
            background-color: transparent; 
            color: #d1d5db; 
        }
        .accordion-item {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .accordion-item.illuminated {
            box-shadow: 0 0 25px rgba(251, 146, 60, 0.3), inset 0 0 10px rgba(251, 146, 60, 0.1);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1), padding 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0 1.5rem;
        }
        .accordion-content.open {
            max-height: 2000px;
            padding: 1.5rem;
        }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease-in-out; }
        .modal-backdrop, .modal-content {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            pointer-events: none;
        }
        .modal-backdrop.open, .modal-content.open {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .category-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
        }
        .accordion-icon {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .timeline-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .timeline-container::-webkit-scrollbar {
            display: none;
        }
        .timeline-day, .grid-day {
            background-color: #374151;
            border-radius: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .timeline-day { flex: 0 0 60px; padding: 0.75rem 0.25rem; }
        .grid-day { aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2px; }
        .timeline-day:hover, .grid-day:hover:not(.out-of-range) { background-color: #4b5563; }
        .timeline-day.scheduled::after, .grid-day.scheduled::after {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #facc15;
        }
        .timeline-day.completed, .grid-day.completed {
            background-color: #f97316;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
        }
        .timeline-day.completed::after, .grid-day.completed::after { display: none; }
        .timeline-day.today, .grid-day.today { border: 2px solid #fb923c; }
        .grid-day.other-month { color: #4b5563; background-color: #1f2937; cursor: default; }
        .grid-day.in-range { background-color: rgba(55, 65, 81, 0.5); }
        .grid-day.start-date, .timeline-day.start-date { background-color: #fbbf24; color: #111827; }
        .grid-day.out-of-range, .timeline-day.out-of-range { background-color: #1f2937; color: #4b5563; cursor: not-allowed; }
        
        #view-toggle:checked ~ .relative .dot {
            transform: translateX(1.5rem);
            background-color: #f97316;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500 tracking-tight">Tu Viaje de 3 Meses</h1>
            <p class="text-xl text-slate-400 mt-2">Plan Progresivo para Movilidad y Fuerza Funcional</p>
        </header>

        <div class="sticky top-4 z-40 bg-[#111827]/80 backdrop-blur-sm py-4">
            <div class="w-full bg-gray-700 rounded-full h-3 mb-4 shadow-inner">
                <div id="progress-bar" class="bg-gradient-to-r from-amber-500 to-orange-600 h-3 rounded-full progress-bar-fill" style="width: 33.33%"></div>
            </div>
            <nav class="flex justify-center p-1 bg-gray-800/80 rounded-full shadow-lg">
                <button data-month="1" class="month-tab flex-1 py-3 px-2 text-center font-bold text-lg transition-all duration-300 rounded-full tab-active">Mes 1: Adaptación</button>
                <button data-month="2" class="month-tab flex-1 py-3 px-2 text-center font-bold text-lg transition-all duration-300 rounded-full tab-inactive">Mes 2: Intensificación</button>
                <button data-month="3" class="month-tab flex-1 py-3 px-2 text-center font-bold text-lg transition-all duration-300 rounded-full tab-inactive">Mes 3: Potencia</button>
            </nav>
        </div>
        
        <main id="plan-content" class="transition-opacity duration-500 mt-8">
        </main>
        
        <section id="progress-section" class="mt-12">
             <div class="bg-gray-800/50 p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-3xl font-bold text-slate-200">Mi Centro de Mando</h2>
                    <label for="view-toggle" class="flex items-center cursor-pointer">
                        <span id="view-label-left" class="mr-3 text-sm font-medium">Progreso</span>
                        <div class="relative">
                            <input type="checkbox" id="view-toggle" class="sr-only">
                            <div class="block bg-gray-600 w-14 h-8 rounded-full">
                                <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                            </div>
                        </div>
                        <span id="view-label-right" class="ml-3 text-sm font-medium">Planificación</span>
                    </label>
                </div>

                <div id="calendar-container"></div>
                
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 mt-8">
                    <div class="lg:col-span-3">
                         <h3 class="text-xl font-bold text-white mb-4">Análisis de Cumplimiento (12 Semanas)</h3>
                        <div class="chart-container h-64">
                            <canvas id="compliance-chart"></canvas>
                        </div>
                    </div>
                    <div class="lg:col-span-2 space-y-4">
                         <h3 class="text-xl font-bold text-white mb-4">Inteligencia de Entrenamiento</h3>
                         <div class="bg-gray-900/50 p-4 rounded-xl">
                            <p class="text-sm text-slate-400">Cumplimiento Total</p>
                            <p id="total-compliance" class="text-3xl font-extrabold text-amber-400">0%</p>
                         </div>
                         <div class="bg-gray-900/50 p-4 rounded-xl">
                            <p class="text-sm text-slate-400">Racha de Semanas Perfectas</p>
                            <p id="perfect-streak" class="text-3xl font-extrabold text-orange-500">0</p>
                         </div>
                         <div class="bg-gray-900/50 p-4 rounded-xl">
                            <p class="text-sm text-slate-400">Entrenamientos Totales</p>
                            <p id="total-workouts" class="text-3xl font-extrabold text-white">0</p>
                         </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <div id="exercise-modal" class="modal-backdrop fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-[#1f2937] border border-gray-700 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-2 text-right">
                 <button id="modal-close" class="text-slate-400 hover:text-red-500 transition-colors text-5xl leading-none">&times;</button>
            </div>
            <div class="p-6 pt-0 grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div>
                    <img id="modal-img" src="" alt="Demostración del ejercicio" class="w-full h-auto object-cover rounded-xl shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/600x400/111827/d1d5db?text=Imagen+no+disponible';">
                </div>
                <div class="flex flex-col h-full">
                    <div id="modal-tags" class="mb-3"></div>
                    <h3 id="modal-title" class="text-4xl font-extrabold text-white mb-2"></h3>
                    <div class="w-16 h-1.5 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full mb-4"></div>
                    <p id="modal-desc" class="text-slate-300 leading-relaxed overflow-y-auto"></p>
                </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal" class="modal-backdrop fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-[#1f2937] border border-gray-700 rounded-2xl shadow-2xl w-full max-w-md">
             <div class="p-6 text-center">
                <h3 id="assignment-title" class="text-2xl font-bold text-white mb-4"></h3>
                <p id="assignment-date" class="text-slate-400 mb-6"></p>
                <div id="assignment-options" class="space-y-3"></div>
                <button id="delete-assignment" class="hidden mt-4 w-full p-3 bg-red-800/50 rounded-lg text-red-400 font-semibold hover:bg-red-700/50 transition-colors">Borrar Programación</button>
                <button id="cancel-assignment" class="mt-6 text-slate-400 hover:text-white">Cancelar</button>
             </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {

const planData = {
    warmups: {
        "1": [
            { name: "Respiración Diafragmática", desc: "Tumbado boca arriba, inhala profundo por la nariz (4s), siente cómo se expande tu abdomen, no el pecho. Sostén (2s) y exhala lentamente por la boca (6s). Esto calma el sistema nervioso y prepara tu core desde adentro. Repite por 2-3 minutos.", img: "https://i.imgur.com/v6mB4gC.gif", category: "Movilidad" },
            { name: "Gato-Vaca", reps: "15 reps", desc: "A gatas, inhala mientras arqueas la espalda y miras al frente (Vaca). Exhala mientras redondeas la columna y metes la barbilla (Gato). Esencial para lubricar las vértebras y despertar la columna.", img: "https://i.imgur.com/sS4m3t4.gif", category: "Movilidad" },
            { name: "Bird-Dog", reps: "10 reps x lado", desc: "A gatas, contrae el abdomen y extiende un brazo al frente y la pierna opuesta hacia atrás. Imagina que tienes una bandeja en la espalda y no puedes derramarla. Mantén 3 segundos. Mejora la estabilidad del core y la coordinación.", img: "https://i.imgur.com/Q2xY1VN.gif", category: "Core" },
            { name: "Rotaciones Torácicas Cuadrúpedas", reps: "10 reps x lado", desc: "A gatas, una mano en la nuca. Rota el codo hacia el techo, abriendo el pecho. Es clave para la movilidad de la espalda alta, un área que a menudo acumula rigidez.", img: "https://i.imgur.com/jQ7D3Tz.gif", category: "Movilidad"}
        ],
        "2": [
            { name: "Círculos de Brazos y Piernas", reps: "10 por dirección", desc: "De pie, realiza círculos amplios y controlados con los brazos hacia adelante y atrás. Luego, apóyate en algo y haz lo mismo con cada pierna. Esto lubrica las articulaciones del hombro y la cadera.", img: "https://i.imgur.com/pMWF83v.gif", category: "Movilidad" },
            { name: "Sentadilla Profunda con Rotación", reps: "8 reps x lado", desc: "Baja a una sentadilla profunda, lo más que puedas cómodamente. Apoya un codo en la parte interna de la rodilla y rota el otro brazo hacia el techo. Abre la cadera y la columna torácica simultáneamente.", img: "https://i.imgur.com/e32sgrz.gif", category: "Movilidad" },
            { name: "Plancha con Pasos Laterales", reps: "20 pasos totales", desc: "En posición de plancha alta (manos), da pequeños pasos laterales con manos y pies, moviéndote como un cangrejo. Activa el core y los estabilizadores del hombro de forma dinámica.", img: "https://i.imgur.com/tH3aL5P.gif", category: "Core" },
            { name: "Bisagra de Cadera (Good Morning)", reps: "15 reps", desc: "De pie, manos en la nuca, rodillas ligeramente flexionadas. Empuja la cadera hacia atrás como si quisieras cerrar una puerta, manteniendo la espalda recta. Activa toda la cadena posterior.", img: "https://i.imgur.com/0iSgUu1.gif", category: "Fuerza" }
        ],
        "3": [
            { name: "Saltos de Tijera (Jumping Jacks)", reps: "30 segundos", desc: "Un clásico para elevar el ritmo cardíaco y calentar todo el cuerpo de forma coordinada. Mantén un ritmo constante.", img: "https://i.imgur.com/6aY4j2P.gif", category: "Potencia" },
            { name: "Sentadilla a Zancada Inversa", reps: "8 reps x lado", desc: "Realiza una sentadilla, y al subir, lleva una pierna directamente hacia atrás a una zancada inversa. Fluye de un movimiento a otro. Prepara los patrones de movimiento del día.", img: "https://i.imgur.com/Y351gM4.gif", category: "Coordinación" },
            { name: "Plancha a Perro Boca Abajo", reps: "12 reps", desc: "Desde una plancha alta, eleva la cadera hacia el techo formando una 'V' invertida (Perro Boca Abajo), estirando la espalda y los isquiotibiales. Vuelve a la plancha. Flujo dinámico.", img: "https://i.imgur.com/vLhSgP3.gif", category: "Movilidad" },
            { name: "Paseo del Monstruo (con banda)", reps: "10 pasos x lado", desc: "Si tienes una minibanda, colócala arriba de las rodillas. En posición de media sentadilla, da pasos laterales manteniendo la tensión. Si no tienes banda, hazlo igual, activando los glúteos.", img: "https://i.imgur.com/R3C4dC7.gif", category: "Fuerza" }
        ]
    },
    cooldowns: {
        "1": [
            { name: "Estiramiento de Isquiotibiales", reps: "45 seg x lado", desc: "Sentado, una pierna estirada, la otra flexionada con el pie en el muslo interno. Inclínate hacia adelante desde la cadera, manteniendo la espalda recta. No intentes tocar el pie, solo busca el estiramiento.", img: "https://i.imgur.com/S9s4F16.gif", category: "Flexibilidad" },
            { name: "Estiramiento de Cuádriceps (de pie)", reps: "45 seg x lado", desc: "De pie, sujétate a algo si es necesario. Lleva el talón al glúteo, manteniendo las rodillas juntas. Siente el estiramiento en la parte frontal del muslo.", img: "https://i.imgur.com/pG8kH2G.gif", category: "Flexibilidad" },
            { name: "Estiramiento del Gato (Postura del Niño)", reps: "60 seg", desc: "Desde la posición a gatas, lleva la cadera hacia los talones y extiende los brazos al frente, apoyando la frente en el suelo. Relaja toda la espalda.", img: "https://i.imgur.com/bT6g4jE.gif", category: "Flexibilidad" },
            { name: "Torsión Espinal (tumbado)", reps: "45 seg x lado", desc: "Tumbado, lleva una rodilla al pecho y luego crúzala por encima del cuerpo, girando la cadera. Mantén ambos hombros en el suelo. Libera la tensión de la espalda baja.", img: "https://i.imgur.com/pMWF83v.gif", category: "Movilidad" }
        ],
        "2": [
            { name: "Estiramiento de la Paloma", reps: "60 seg x lado", desc: "Desde plancha, lleva una rodilla hacia la mano del mismo lado y estira la otra pierna hacia atrás. Un estiramiento profundo para el glúteo y el psoas. Si es muy intenso, haz la versión 'Figura 4' tumbado.", img: "https://i.imgur.com/0iSgUu1.gif", category: "Flexibilidad" },
            { name: "Estiramiento de Aductores (Mariposa)", reps: "60 seg", desc: "Sentado, junta las plantas de los pies y acerca los talones al cuerpo. Presiona suavemente las rodillas hacia el suelo con los codos para estirar la parte interna de los muslos.", img: "https://i.imgur.com/R3C4dC7.gif", category: "Flexibilidad" },
            { name: "Estiramiento de Hombro Cruzado", reps: "45 seg x brazo", desc: "Lleva un brazo recto a través del pecho y presiona suavemente con el otro brazo para estirar la parte posterior del hombro.", img: "https://i.imgur.com/qg9nIeC.gif", category: "Flexibilidad" },
            { name: "Postura del Perro Boca Abajo", reps: "60 seg", desc: "Desde plancha, eleva la cadera al techo. Presiona los talones hacia el suelo (no importa si no tocan) y mantén la espalda larga. Estira toda la cadena posterior del cuerpo.", img: "https://i.imgur.com/vLhSgP3.gif", category: "Movilidad" }
        ],
        "3": [
            { name: "Estiramiento del 'Couch Stretch'", reps: "60 seg x lado", desc: "Coloca una rodilla en la esquina de una pared y el pie en la pared. Adelanta la otra pierna. Es el estiramiento más intenso y efectivo para el cuádriceps y el psoas. Procede con cuidado.", img: "https://i.imgur.com/Y351gM4.gif", category: "Flexibilidad" },
            { name: "Estiramiento de la Rana", reps: "60 seg", desc: "A gatas, separa las rodillas lo más que puedas cómodamente, con los pies hacia afuera. Baja la cadera hacia el suelo para un estiramiento profundo de aductores.", img: "https://i.imgur.com/9D6o9a8.gif", category: "Flexibilidad" },
            { name: "Estiramiento de Tríceps sobre la Cabeza", reps: "45 seg x brazo", desc: "Levanta un brazo, flexiona el codo y deja caer la mano por detrás de la cabeza. Usa la otra mano para presionar suavemente el codo hacia abajo.", img: "https://i.imgur.com/k6J1s5T.gif", category: "Flexibilidad" },
            { name: "Estiramiento de Muñecas y Antebrazos", reps: "30 seg cada posición", desc: "A gatas, apoya las palmas de las manos con los dedos apuntando hacia ti. Luego, apoya el dorso de las manos. crucial para la salud de las muñecas en calistenia.", img: "https://i.imgur.com/LFRuL1d.gif", category: "Movilidad" }
        ]
    },
    months: {
        "1": {
            title: "Mes 1: Adaptación y Técnica",
            interval: "40s trabajo / 20s descanso",
            rounds: "3-4",
            hiit_duration: 20,
            days: {
                "day1": { title: "Día 1: Empuje y Core", exercises: [
                    { name: "Sentadilla (Peso Corporal)", desc: "Espalda recta, baja la cadera como si te sentaras. Mantén el pecho erguido. Un pilar fundamental para la fuerza del tren inferior.", img: "https://i.imgur.com/sC3g01M.gif", category: "Fuerza" },
                    { name: "Flexiones Inclinadas", desc: "Manos en un banco o pared. A menor inclinación, mayor dificultad. Cuerpo recto. Ideal para construir fuerza de empuje de forma progresiva.", img: "https://i.imgur.com/k1xPbzH.gif", category: "Fuerza" },
                    { name: "Plancha Frontal", desc: "Cuerpo en línea recta de talones a cabeza. Contrae abdomen y glúteos para máxima efectividad. El rey de la estabilidad del core.", img: "https://i.imgur.com/oef7j2C.gif", category: "Core" },
                    { name: "Remo con Toalla", desc: "Sentado, pasa una toalla por tus pies y tira de ella, retrayendo las escápulas. Fortalece la espalda alta usando solo una toalla.", img: "https://i.imgur.com/AWhh3ng.gif", category: "Fuerza" },
                    { name: "Puente de Glúteos", desc: "Eleva la cadera contrayendo los glúteos, no la espalda baja. Activa la cadena posterior de forma segura.", img: "https://i.imgur.com/3flvDzt.gif", category: "Fuerza" }
                ]},
                "day2": { title: "Día 2: Tracción y Resistencia", exercises: [
                    { name: "Zancadas Alternas", desc: "Da un paso largo y baja la rodilla de atrás casi hasta el suelo. Mantén el torso vertical. Trabaja fuerza y equilibrio.", img: "https://i.imgur.com/V7aQ3er.gif", category: "Fuerza" },
                    { name: "Dominadas Australianas", desc: "Con una barra baja o mesa resistente. Tira del pecho hacia la barra. La mejor preparación para dominadas completas.", img: "https://i.imgur.com/yD9j2rZ.gif", category: "Fuerza" },
                    { name: "Escaladores (Controlados)", desc: "En posición de plancha, lleva las rodillas al pecho lentamente, manteniendo el core estable. Un ejercicio de core dinámico.", img: "https://i.imgur.com/C7nByo5.gif", category: "Core" },
                    { name: "Peso Muerto Rumano (sin peso)", desc: "Concéntrate en la bisagra de cadera, manteniendo la espalda recta. Enseña un patrón de movimiento fundamental.", img: "https://i.imgur.com/TkbIuCo.gif", category: "Movilidad" },
                    { name: "Plancha Lateral", reps: "20s por lado", desc: "Mantén el cuerpo en una línea recta lateral, evitando que la cadera caiga. Fortalece los oblicuos.", img: "https://i.imgur.com/R35Inw6.gif", category: "Core" }
                ]},
                "day3": { title: "Día 3: Full Body y Transferencia", exercises: [
                    { name: "Levantamiento Turco (Parcial)", desc: "Practica solo hasta el paso de apoyarte en la mano y elevar la cadera. Lento y controlado. El ejercicio maestro de la estabilidad.", img: "https://i.imgur.com/mJ9r2tU.gif", category: "Coordinación" },
                    { name: "Swing (con mochila)", desc: "Movimiento explosivo de cadera. Usa una mochila con libros o botellas de agua. Desarrolla potencia en la cadera.", img: "https://i.imgur.com/LFRuL1d.gif", category: "Potencia" },
                    { name: "Caminata del Granjero", desc: "Coge peso en cada mano (garrafas de agua) y camina con la espalda recta. Fortalece el agarre y el core de forma funcional.", img: "https://i.imgur.com/yE7xW9k.gif", category: "Fuerza" },
                    { name: "Subidas al Cajón/Escalón", desc: "Alterna subir a una superficie elevada. Controla la bajada. Un ejercicio de bajo impacto para el tren inferior.", img: "https://i.imgur.com/5V4yL2O.gif", category: "Fuerza" },
                    { name: "Press Pallof (con banda)", desc: "Con una banda elástica de resistencia, extiéndela al frente, resistiendo la rotación. El mejor ejercicio anti-rotación para el core.", img: "https://i.imgur.com/4WqCgN2.gif", category: "Core" }
                ]}
            }
        },
        "2": {
            title: "Mes 2: Intensificación",
            interval: "45s trabajo / 15s descanso",
            rounds: "4",
            hiit_duration: 25,
            days: {
                "day1": { title: "Día 1: Fuerza Unilateral", exercises: [
                    { name: "Sentadilla Búlgara", desc: "Pie trasero elevado en una silla. Baja hasta que el muslo delantero esté paralelo al suelo. Reta el equilibrio y la fuerza de cada pierna.", img: "https://i.imgur.com/M9y9rL6.gif", category: "Fuerza" },
                    { name: "Flexiones con Liberación de Manos", desc: "Baja hasta el suelo, levanta las manos brevemente y empuja hacia arriba explosivamente. Aumenta la potencia de empuje.", img: "https://i.imgur.com/tYV9L39.gif", category: "Potencia" },
                    { name: "Plancha con Alcance", desc: "En posición de plancha, extiende un brazo hacia adelante sin rotar las caderas. Un reto avanzado para la estabilidad del core.", img: "https://i.imgur.com/PabA5CT.gif", category: "Core" },
                    { name: "Remo a una Mano (con mochila)", desc: "Inclínate con la espalda recta, apoya una mano en una silla y rema con la otra. Corrige desbalances de fuerza.", img: "https://i.imgur.com/3Jg9g20.gif", category: "Fuerza" },
                    { name: "Elevación de Cadera a una Pierna", desc: "Igual que el puente de glúteos, pero con una pierna extendida. Aumenta la activación del glúteo.", img: "https://i.imgur.com/sHjJzwy.gif", category: "Fuerza" }
                ]},
                "day2": { title: "Día 2: Resistencia y Core Avanzado", exercises: [
                    { name: "Zancada Inversa con Elevación", desc: "Da un paso hacia atrás en una zancada y al volver, eleva la rodilla al pecho. Combina fuerza, equilibrio y coordinación.", img: "https://i.imgur.com/1G2t82j.gif", category: "Coordinación" },
                    { name: "Flexiones en Pica", desc: "Desde una posición de 'V' invertida, baja la cabeza hacia el suelo. Trabaja los hombros, preparando para el handstand.", img: "https://i.imgur.com/eB3dGSA.gif", category: "Fuerza" },
                    { name: "Plancha Spiderman", desc: "En posición de plancha, lleva la rodilla hacia el codo del mismo lado. Trabaja oblicuos y movilidad de cadera.", img: "https://i.imgur.com/B9OcyL3.gif", category: "Core" },
                    { name: "Buenos Días (sin peso)", desc: "De pie, manos en la nuca. Realiza una bisagra de cadera manteniendo la espalda recta. Fortalece la cadena posterior.", img: "https://i.imgur.com/0iSgUu1.gif", category: "Fuerza" },
                    { name: "Limpia Parabrisas (Tumbado)", desc: "Boca arriba, piernas a 90 grados. Déjalas caer de lado a lado sin tocar el suelo. Control y fuerza rotacional del core.", img: "https://i.imgur.com/N7iVd9q.gif", category: "Core" }
                ]},
                "day3": { title: "Día 3: Potencia y Coordinación", exercises: [
                    { name: "Sentadilla con Salto", desc: "Realiza una sentadilla y salta explosivamente. Aterriza suavemente, absorbiendo el impacto. Desarrolla potencia en el tren inferior.", img: "https://i.imgur.com/rGgXp2e.gif", category: "Potencia" },
                    { name: "Flexiones Declinadas", desc: "Pies elevados en una silla o escalón. Mayor énfasis en la parte superior del pecho y hombros.", img: "https://i.imgur.com/9C0D3J1.gif", category: "Fuerza" },
                    { name: "Burpee (sin flexión)", desc: "Baja a posición de plancha, vuelve a ponerte de pie y estira los brazos. Un ejercicio cardiovascular de cuerpo completo.", img: "https://i.imgur.com/tH3aL5P.gif", category: "Potencia" },
                    { name: "Paseo del Cangrejo", desc: "Sentado, manos y pies en el suelo. Eleva la cadera y camina hacia adelante y atrás. Mejora la coordinación y la fuerza de la cadena posterior.", img: "https://i.imgur.com/9D6o9a8.gif", category: "Coordinación" },
                    { name: "Toques al Talón (Tumbado)", desc: "Boca arriba, rodillas flexionadas. Levanta cabeza y hombros y toca alternativamente cada talón. Enfocado en los oblicuos.", img: "https://i.imgur.com/xTafL6z.gif", category: "Core" }
                ]}
            }
        },
        "3": {
            title: "Mes 3: Potencia y Flujo",
            interval: "50s trabajo / 10s descanso",
            rounds: "4-5",
            hiit_duration: 30,
            days: {
                "day1": { title: "Día 1: Complejos de Fuerza", exercises: [
                    { name: "Sentadilla Pistola (asistida)", desc: "Sujétate al marco de una puerta o una silla y realiza una sentadilla a una pierna. La máxima expresión de fuerza y equilibrio unilateral.", img: "https://i.imgur.com/L4DbDqs.gif", category: "Fuerza" },
                    { name: "Flexión Arquero", desc: "Desde una posición de flexión ancha, desplaza el peso hacia un lado, estirando el otro brazo. Un paso previo a la flexión a una mano.", img: "https://i.imgur.com/o0scH67.gif", category: "Fuerza" },
                    { name: "Plancha a Plancha Baja", desc: "Desde plancha de manos, baja a plancha de codos y vuelve a subir. Alterna el brazo que inicia. Resistencia y estabilidad.", img: "https://i.imgur.com/zAUmE4a.gif", category: "Core" },
                    { name: "Remo Renegado (con garrafas)", desc: "En posición de plancha sobre dos garrafas de agua, rema alternativamente cada una. Un reto total para el core y la espalda.", img: "https://i.imgur.com/uNlq3sF.gif", category: "Fuerza" },
                    { name: "Elevación de Piernas (Tumbado)", desc: "Boca arriba, levanta las piernas rectas hasta 90 grados y bájalas lentamente. Fortalece la parte baja del abdomen.", img: "https://i.imgur.com/L3TYgko.gif", category: "Core" }
                ]},
                "day2": { title: "Día 2: Agilidad y Resistencia Total", exercises: [
                    { name: "Zancada con Salto", desc: "Desde una posición de zancada, salta y cambia las piernas en el aire. Exige control y potencia.", img: "https://i.imgur.com/BvLvhM4.gif", category: "Potencia" },
                    { name: "Flexión Hindú", desc: "Desde pica, baja en un movimiento fluido hasta una cobra y vuelve. Combina movilidad, fuerza y flujo.", img: "https://i.imgur.com/L79pY5M.gif", category: "Coordinación" },
                    { name: "Oso Gateando (Bear Crawl)", desc: "A gatas con las rodillas flotando, avanza coordinando brazo y pierna opuestos. Mejora la coordinación y la fuerza del core.", img: "https://i.imgur.com/gK9o9b0.gif", category: "Coordinación" },
                    { name: "Sentadilla Cosaca", desc: "Desde una postura amplia, desplaza el peso a un lado, bajando la cadera y manteniendo la otra pierna estirada. Movilidad y fuerza lateral.", img: "https://i.imgur.com/mO2P2j1.gif", category: "Movilidad" },
                    { name: "Abdominales en V (V-Ups)", desc: "Tumbado, levanta simultáneamente torso y piernas para formar una 'V' con tu cuerpo. Un ejercicio avanzado para el abdomen.", img: "https://i.imgur.com/e5j2jYw.gif", category: "Core" }
                ]},
                "day3": { title: "Día 3: Reto de Calistenia", exercises: [
                    { name: "Paseo por la Pared (Wall Walk)", desc: "Empieza en plancha con los pies en la pared y camina con las manos hacia ella, elevando la cadera. El camino hacia el handstand.", img: "https://i.imgur.com/wVbKQzP.gif", category: "Fuerza" },
                    { name: "Flexión a una Mano (negativa)", desc: "Baja lo más lento que puedas usando solo un brazo. Ayúdate con ambos para subir. Construye la fuerza para el movimiento completo.", img: "https://i.imgur.com/S9s4F16.gif", category: "Fuerza" },
                    { name: "Plancha Superman", desc: "En posición de plancha, extiende un brazo y la pierna opuesta. Máxima tensión y control del core.", img: "https://i.imgur.com/s6wJ7c3.gif", category: "Core" },
                    { name: "Sentadilla Camarón (asistida)", desc: "Sujeta un pie por detrás y baja en una sentadilla con la otra pierna. Usa apoyo si es necesario. Un reto de equilibrio y fuerza.", img: "https://i.imgur.com/R3C4dC7.gif", category: "Fuerza" },
                    { name: "L-Sit (Tuck Sit)", desc: "En el suelo o en paralelas improvisadas (sillas), eleva las rodillas al pecho contrayendo el abdomen. Un fundamental de la calistenia.", img: "https://i.imgur.com/J7t6z8S.gif", category: "Core" }
                ]}
            }
        }
    }
};

    let completedDays = {};
    const STORAGE_KEY = 'workoutProgress';

    const planContent = document.getElementById('plan-content');
    const monthTabs = document.querySelectorAll('.month-tab');
    const progressBar = document.getElementById('progress-bar');
    const modal = document.getElementById('exercise-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImg = document.getElementById('modal-img');
    const modalDesc = document.getElementById('modal-desc');
    const modalClose = document.getElementById('modal-close');
    const modalTags = document.getElementById('modal-tags');
    const assignmentModal = document.getElementById('assignment-modal');
    const assignmentTitle = document.getElementById('assignment-title');
    const assignmentDateEl = document.getElementById('assignment-date');
    const assignmentOptionsEl = document.getElementById('assignment-options');
    const cancelAssignmentBtn = document.getElementById('cancel-assignment');
    const deleteAssignmentBtn = document.getElementById('delete-assignment');
    const viewToggle = document.getElementById('view-toggle');
    const calendarContainer = document.getElementById('calendar-container');

    let currentChart = null;
    let complianceChart = null;
    let isFullView = false;
    let planningViewDate = new Date();
    
    const categoryColors = {
        "Fuerza": "bg-orange-200/20 text-orange-400",
        "Core": "bg-yellow-200/20 text-yellow-400",
        "Movilidad": "bg-green-200/20 text-green-400",
        "Potencia": "bg-red-200/20 text-red-400",
        "Coordinación": "bg-sky-200/20 text-sky-400",
        "Flexibilidad": "bg-purple-200/20 text-purple-400"
    };

    function showModal(exercise) {
        if (!exercise) return;
        modalTitle.textContent = exercise.name;
        modalImg.src = exercise.img;
        modalDesc.textContent = exercise.desc;
        
        modalTags.innerHTML = '';
        if (exercise.category) {
            const tag = document.createElement('span');
            tag.textContent = exercise.category;
            tag.className = `category-tag ${categoryColors[exercise.category] || 'bg-slate-100 text-slate-800'}`;
            modalTags.appendChild(tag);
        }

        modal.classList.add('open');
        modal.querySelector('.modal-content').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function hideModal() {
        modal.classList.remove('open');
        modal.querySelector('.modal-content').classList.remove('open');
        document.body.style.overflow = 'auto';
    }
    
    function hideAssignmentModal() {
        assignmentModal.classList.remove('open');
        assignmentModal.querySelector('.modal-content').classList.remove('open');
        document.body.style.overflow = 'auto';
    }


    modalClose.addEventListener('click', hideModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });
    
    cancelAssignmentBtn.addEventListener('click', hideAssignmentModal);
    
    function createExerciseCard(exercise) {
        const card = document.createElement('div');
        card.className = 'exercise-card bg-gray-800/50 p-3 rounded-xl shadow-lg flex items-center gap-4 cursor-pointer hover:shadow-2xl hover:ring-2 hover:ring-orange-500 transition-all duration-300 transform hover:-translate-y-1 group';
        card.dataset.exerciseName = exercise.name;
        card.innerHTML = `
            <img src="${exercise.img}" alt="${exercise.name}" class="w-24 h-24 object-cover rounded-lg bg-slate-700 flex-shrink-0" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/100x100/111827/d1d5db?text=Img';">
            <div class="flex-grow">
                <h4 class="font-bold text-lg text-slate-100">${exercise.name}</h4>
                ${exercise.reps ? `<p class="text-slate-400">${exercise.reps}</p>` : ''}
            </div>
            <span class="text-orange-500 font-bold text-3xl transition-transform duration-300 group-hover:translate-x-1">&#8594;</span>
        `;
        return card;
    }
    
    function renderDay(month, dayKey) {
        const dayData = planData.months[month].days[dayKey];
        const warmupData = planData.warmups[month];
        const cooldownData = planData.cooldowns[month];
        const workoutDetails = document.getElementById('workout-details');
        
        if (!dayData) {
            workoutDetails.innerHTML = `<div class="text-center text-slate-400 p-8 bg-gray-800/30 rounded-xl">Haz clic en un día del calendario para programar o ver un entrenamiento.</div>`;
            return;
        }

        workoutDetails.innerHTML = `
            <div class="space-y-4">
                <div class="accordion-item rounded-xl shadow-lg overflow-hidden">
                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left font-semibold text-xl text-slate-100">
                        <span><span class="text-orange-400 mr-2 font-black">A</span> Calentamiento y Movilidad</span>
                        <div class="accordion-icon text-orange-400 text-2xl relative w-6 h-6"><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2"></div><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2 transition-transform duration-500 transform rotate-90"></div></div>
                    </button>
                    <div class="accordion-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="warmup-container"></div>
                    </div>
                </div>
                <div class="accordion-item rounded-xl shadow-lg overflow-hidden">
                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left font-semibold text-xl text-slate-100">
                        <span><span class="text-orange-400 mr-2 font-black">B</span> Circuito HIIT: ${dayData.title}</span>
                         <div class="accordion-icon text-orange-400 text-2xl relative w-6 h-6"><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2"></div><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2 transition-transform duration-500 transform rotate-90"></div></div>
                    </button>
                    <div class="accordion-content">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="hiit-container"></div>
                    </div>
                </div>
                <div class="accordion-item rounded-xl shadow-lg overflow-hidden">
                    <button class="accordion-header w-full flex justify-between items-center p-5 text-left font-semibold text-xl text-slate-100">
                        <span><span class="text-orange-400 mr-2 font-black">C</span> Enfriamiento y Estiramientos</span>
                         <div class="accordion-icon text-orange-400 text-2xl relative w-6 h-6"><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2"></div><div class="absolute bg-current w-full h-0.5 top-1/2 -translate-y-1/2 transition-transform duration-500 transform rotate-90"></div></div>
                    </button>
                    <div class="accordion-content">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="cooldown-container"></div>
                    </div>
                </div>
            </div>
        `;
        
        const warmupContainer = document.getElementById('warmup-container');
        warmupData.forEach(ex => warmupContainer.appendChild(createExerciseCard(ex)));
        
        const hiitContainer = document.getElementById('hiit-container');
        dayData.exercises.forEach(ex => hiitContainer.appendChild(createExerciseCard(ex)));

        const cooldownContainer = document.getElementById('cooldown-container');
        cooldownData.forEach(ex => cooldownContainer.appendChild(createExerciseCard(ex)));
        
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.addEventListener('click', () => {
                const item = header.parentElement;
                const content = header.nextElementSibling;
                const icon = header.querySelector('.accordion-icon div:last-child');
                const isOpen = content.classList.contains('open');

                document.querySelectorAll('.accordion-content.open').forEach(openContent => {
                    if (openContent !== content) {
                        openContent.classList.remove('open');
                        const openItem = openContent.parentElement;
                        openItem.classList.remove('illuminated');
                        openItem.querySelector('.accordion-icon div:last-child').style.transform = 'rotate(90deg)';
                    }
                });
                
                content.classList.toggle('open');
                item.classList.toggle('illuminated');
                icon.style.transform = content.classList.contains('open') ? 'rotate(0deg)' : 'rotate(90deg)';
            });
        });
    }

    function renderPlan(month) {
        const monthData = planData.months[month];
        planContent.innerHTML = `
            <div id="workout-details">
                <div class="text-center text-slate-400 p-8 bg-gray-800/30 rounded-xl">Haz clic en un día del calendario para programar o ver un entrenamiento.</div>
            </div>
            <div id="chart-section" class="mt-12 accordion-item rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-center mb-4 text-slate-100">Distribución de la Sesión - Mes ${month}</h3>
                <div class="chart-container" style="height: 200px; max-width: 200px; margin: auto;">
                    <canvas id="session-chart"></canvas>
                </div>
                <div id="chart-legend" class="mt-4 flex justify-center gap-4 text-sm flex-wrap text-slate-300"></div>
            </div>
        `;

        planContent.addEventListener('click', e => {
            const cardTarget = e.target.closest('.exercise-card');
            if(cardTarget){
                const exerciseName = cardTarget.dataset.exerciseName;
                const allExercises = [...planData.warmups[1],...planData.warmups[2],...planData.warmups[3], ...planData.cooldowns[1],...planData.cooldowns[2],...planData.cooldowns[3]];
                Object.values(planData.months).forEach(m => Object.values(m.days).forEach(d => allExercises.push(...d.exercises)));
                const exercise = allExercises.find(ex => ex.name === exerciseName);
                showModal(exercise);
            }
        });
        
        if (currentChart) {
            currentChart.destroy();
        }
        const ctx = document.getElementById('session-chart').getContext('2d');
        const legendContainer = document.getElementById('chart-legend');
        legendContainer.innerHTML = ''; 
        
        const chartStructure = [
            { label: 'Calentamiento', duration: 15, color: 'rgba(251, 146, 60, 0.7)' },
            { label: 'HIIT', duration: monthData.hiit_duration, color: 'rgba(249, 115, 22, 0.9)' },
            { label: 'Enfriamiento', duration: 10, color: 'rgba(234, 88, 12, 0.8)' }
        ];

        const chartData = {
            labels: chartStructure.map(s => s.label),
            datasets: [{
                data: chartStructure.map(s => s.duration),
                backgroundColor: chartStructure.map(s => s.color),
                borderColor: '#1f2937',
                borderWidth: 0,
                hoverOffset: 8,
                hoverBorderColor: '#111827'
            }]
        };

        currentChart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1f2937',
                        titleFont: { size: 16, weight: 'bold'},
                        bodyFont: { size: 14, color: '#d1d5db' },
                        padding: 12,
                        cornerRadius: 8,
                        callbacks: {
                            label: (context) => `${context.label}: ${context.raw} min (aprox.)`
                        }
                    }
                }
            }
        });

        chartData.labels.forEach((label, index) => {
            const legendItem = document.createElement('div');
            legendItem.className = 'flex items-center';
            legendItem.innerHTML = `
                <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${chartData.datasets[0].backgroundColor[index]}"></span>
                <span>${label}</span>
            `;
            legendContainer.appendChild(legendItem);
        });
    }

    monthTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const month = tab.dataset.month;
            renderPlan(month);
            monthTabs.forEach(t => {
                t.classList.remove('tab-active');
                t.classList.add('tab-inactive');
            });
            tab.classList.add('tab-active');
            tab.classList.remove('tab-inactive');
            
            progressBar.style.width = `${(parseInt(month) / 3 * 100)}%`;
        });
    });
    
    // Calendar Logic
    function loadProgress() {
        const data = localStorage.getItem(STORAGE_KEY);
        completedDays = data ? JSON.parse(data) : {};
    }

    function saveProgress() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(completedDays));
        updateAnalytics();
    }

    function renderCalendars(scrollToToday = false) {
        if(isFullView){
            renderFullCalendar();
        } else {
            renderTimelineCalendar(scrollToToday);
        }
    }

    function renderTimelineCalendar(scrollToToday = false) {
        const timelineEl = calendarContainer.querySelector('#timeline-calendar');
        const scrollPosition = timelineEl ? timelineEl.scrollLeft : 0;
        
        calendarContainer.innerHTML = `<div id="timeline-calendar" class="timeline-container flex items-center gap-2 p-2 overflow-x-auto"></div>`;
        const newTimelineEl = document.getElementById('timeline-calendar');
        newTimelineEl.innerHTML = '';
        
        const today = new Date();
        const startDate = new Date();
        startDate.setDate(today.getDate() - 182);

        for (let i = 0; i < 365; i++) {
            const day = new Date(startDate);
            day.setDate(startDate.getDate() + i);
            const dateStr = `${day.getFullYear()}-${String(day.getMonth() + 1).padStart(2, '0')}-${String(day.getDate()).padStart(2, '0')}`;
            
            const dayEl = document.createElement('div');
            dayEl.className = 'timeline-day flex flex-col justify-center items-center';
            dayEl.dataset.date = dateStr;
            dayEl.innerHTML = `
                <span class="text-xs uppercase">${day.toLocaleString('es-ES', { weekday: 'short' })}</span>
                <span class="text-2xl font-bold">${day.getDate()}</span>
            `;

            const planStartDate = localStorage.getItem('workoutStartDate');
            if (planStartDate && day < new Date(planStartDate + 'T00:00:00')) {
                dayEl.classList.add('out-of-range');
            }

            if (completedDays[dateStr]) {
                 if(completedDays[dateStr].completed){
                    dayEl.classList.add('completed');
                 } else {
                    dayEl.classList.add('scheduled', completedDays[dateStr].workout);
                 }
            }
            if(day.toDateString() === new Date().toDateString()){
                 dayEl.classList.add('today');
            }
            if(dateStr === planStartDate) {
                dayEl.classList.add('start-date');
            }
            newTimelineEl.appendChild(dayEl);
        }
        if(scrollToToday) {
            setTimeout(() => {
                const todayEl = document.querySelector('.timeline-day.today');
                if(todayEl) {
                    todayEl.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            }, 100);
        } else if (scrollPosition) {
            newTimelineEl.scrollLeft = scrollPosition;
        }
    }
    
    function renderFullCalendar() {
        let planStartDate = localStorage.getItem('workoutStartDate');
        let rangeEndDate = null;
        if(planStartDate) {
            rangeEndDate = new Date(planStartDate);
            rangeEndDate.setDate(rangeEndDate.getDate() + 83);
        }

        calendarContainer.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                 <button id="prev-block-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">&lt; 3 Meses</button>
                 <h4 id="planning-view-header" class="text-lg font-bold text-center text-amber-400"></h4>
                 <button id="next-block-btn" class="p-2 rounded-full hover:bg-gray-700 transition-colors">3 Meses &gt;</button>
            </div>
            <div id="planning-grid-container" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            <div id="plan-end-date-info" class="text-center text-slate-400 text-sm mt-4 h-5 flex justify-center items-center gap-4"></div>
        `;

        const planningGridContainer = document.getElementById('planning-grid-container');
        let date = new Date(planningViewDate);
        date.setDate(1);

        for (let i = 0; i < 3; i++) {
            const monthDiv = document.createElement('div');
            const monthHeader = document.createElement('h4');
            monthHeader.className = 'text-md font-bold text-center text-white mb-2';
            monthHeader.textContent = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            monthDiv.appendChild(monthHeader);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-1';
            ['D', 'L', 'M', 'X', 'J', 'V', 'S'].forEach(day => grid.innerHTML += `<span>${day}</span>`);
            monthDiv.appendChild(grid);
            
            const daysGrid = document.createElement('div');
            daysGrid.className = 'grid grid-cols-7 gap-1';
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let j = 0; j < firstDayOfMonth; j++) {
                daysGrid.innerHTML += `<div></div>`;
            }

            for (let j = 1; j <= daysInMonth; j++) {
                const dayEl = document.createElement('div');
                const currentDate = new Date(year, month, j);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(j).padStart(2, '0')}`;
                dayEl.className = 'grid-day';
                dayEl.textContent = j;
                dayEl.dataset.date = dateStr;

                if (completedDays[dateStr]) {
                    if (completedDays[dateStr].completed) dayEl.classList.add('completed');
                    else dayEl.classList.add('scheduled', completedDays[dateStr].workout);
                }
                if (currentDate.toDateString() === new Date().toDateString()) dayEl.classList.add('today');

                if(planStartDate) {
                    const startDateObj = new Date(planStartDate + 'T00:00:00');
                    if (currentDate >= startDateObj && currentDate <= rangeEndDate) {
                        dayEl.classList.add('in-range');
                    } else {
                         dayEl.classList.add('out-of-range');
                    }
                     if(dateStr === planStartDate) dayEl.classList.add('start-date');
                }
                
                daysGrid.appendChild(dayEl);
            }
            monthDiv.appendChild(daysGrid);
            planningGridContainer.appendChild(monthDiv);
            date.setMonth(date.getMonth() + 1);
        }

        document.getElementById('prev-block-btn').addEventListener('click', () => {
            planningViewDate.setMonth(planningViewDate.getMonth() - 3);
            renderFullCalendar();
        });
        document.getElementById('next-block-btn').addEventListener('click', () => {
            planningViewDate.setMonth(planningViewDate.getMonth() + 3);
            renderFullCalendar();
        });

        const infoContainer = document.getElementById('plan-end-date-info');
        infoContainer.innerHTML = '';
        if(planStartDate){
             infoContainer.innerHTML = `<span>Tu plan de 12 semanas termina el ${rangeEndDate.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}.</span> <button id="reset-start-date" class="text-xs bg-yellow-800/80 text-yellow-300 px-2 py-1 rounded-md hover:bg-yellow-700">Resetear Inicio</button>`;
             document.getElementById('reset-start-date').addEventListener('click', () => {
                localStorage.removeItem('workoutStartDate');
                renderCalendars();
                updateAnalytics();
             });
        } else {
             infoContainer.textContent = 'Haz clic en un día para establecer el inicio de tu plan de 12 semanas.';
        }
        if (Object.keys(completedDays).length > 0) {
            const clearBtn = document.createElement('button');
            clearBtn.id = 'clear-all-marks';
            clearBtn.className = 'text-xs bg-red-800/80 text-red-300 px-2 py-1 rounded-md hover:bg-red-700 ml-2';
            clearBtn.textContent = 'Limpiar Todo';
            clearBtn.onclick = showClearAllConfirmation;
             infoContainer.appendChild(clearBtn);
        }
    }
    
    viewToggle.addEventListener('change', () => {
        isFullView = viewToggle.checked;
        const dot = document.querySelector('.dot');
        dot.style.transform = isFullView ? 'translateX(1.5rem)' : 'translateX(0)';
        planningViewDate = new Date();
        renderCalendars(true);
    });
    
    calendarContainer.addEventListener('click', e => {
        const target = e.target.closest('.timeline-day, .grid-day');
        if (target && target.dataset.date) {
            handleDayClick(target.dataset.date);
        }
    });

    function handleDayClick(date) {
        const entry = completedDays[date];
        const activeMonth = document.querySelector('.month-tab.tab-active').dataset.month;
        const monthWorkouts = planData.months[activeMonth].days;
        const planStartDate = localStorage.getItem('workoutStartDate');
        const clickedDate = new Date(date + 'T00:00:00');

        if(planStartDate && clickedDate < new Date(planStartDate + 'T00:00:00')) {
            return;
        }

        assignmentDateEl.textContent = clickedDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        assignmentOptionsEl.innerHTML = '';
        deleteAssignmentBtn.style.display = 'none';

        if (!isFullView) { // --- PROGRESS VIEW LOGIC ---
            if (entry) {
                entry.completed = !entry.completed;
                saveProgress();
                renderCalendars(false);
                renderDay(entry.month, entry.workout);
            } else {
                assignmentTitle.textContent = "Programar Entrenamiento";
                 if (!planStartDate) {
                    const startPlanBtn = document.createElement('button');
                    startPlanBtn.className = 'w-full p-3 bg-green-600 rounded-lg text-white font-semibold hover:bg-green-500 transition-colors';
                    startPlanBtn.textContent = 'Establecer como Primer Día del Plan';
                    startPlanBtn.onclick = () => {
                        localStorage.setItem('workoutStartDate', date);
                        renderCalendars(false);
                        hideAssignmentModal();
                    }
                    assignmentOptionsEl.appendChild(startPlanBtn);
                }
                Object.keys(monthWorkouts).forEach(dayKey => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'w-full p-3 bg-gray-700 rounded-lg text-white font-semibold hover:bg-orange-600 transition-colors';
                    optionBtn.textContent = `Programar: ${monthWorkouts[dayKey].title}`;
                    optionBtn.onclick = () => {
                        if (!localStorage.getItem('workoutStartDate')) {
                            localStorage.setItem('workoutStartDate', date);
                        }
                        completedDays[date] = { workout: dayKey, completed: false, month: activeMonth };
                        saveProgress();
                        renderCalendars(false);
                        hideAssignmentModal();
                    };
                    assignmentOptionsEl.appendChild(optionBtn);
                });
                assignmentModal.classList.add('open');
                assignmentModal.querySelector('.modal-content').classList.add('open');
            }
            return;
        }

        // --- PLANNING VIEW LOGIC ---
        assignmentTitle.textContent = "Acciones de Planificación";
        if (entry) {
             const unmarkBtn = document.createElement('button');
             unmarkBtn.className = 'w-full p-3 bg-yellow-600 rounded-lg text-white font-semibold hover:bg-yellow-500 transition-colors';
             unmarkBtn.textContent = "Desmarcar Día (Volver a Programado)";
             unmarkBtn.onclick = () => {
                entry.completed = false;
                saveProgress();
                renderCalendars();
                hideAssignmentModal();
             };
             if(entry.completed) assignmentOptionsEl.appendChild(unmarkBtn);

             deleteAssignmentBtn.style.display = 'block';
             deleteAssignmentBtn.onclick = () => {
                delete completedDays[date];
                saveProgress();
                renderCalendars();
                hideAssignmentModal();
            };
        } else {
             if (!planStartDate) {
                const startPlanBtn = document.createElement('button');
                startPlanBtn.className = 'w-full p-3 bg-green-600 rounded-lg text-white font-semibold hover:bg-green-500 transition-colors';
                startPlanBtn.textContent = `Establecer como Primer Día`;
                startPlanBtn.onclick = () => {
                    localStorage.setItem('workoutStartDate', date);
                    renderCalendars();
                    hideAssignmentModal();
                };
                assignmentOptionsEl.appendChild(startPlanBtn);
            }
            Object.keys(monthWorkouts).forEach(dayKey => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'w-full p-3 bg-gray-700 rounded-lg text-white font-semibold hover:bg-orange-600 transition-colors';
                optionBtn.textContent = `Programar: ${monthWorkouts[dayKey].title}`;
                optionBtn.onclick = () => {
                    if (!localStorage.getItem('workoutStartDate')) {
                        localStorage.setItem('workoutStartDate', date);
                    }
                    completedDays[date] = { workout: dayKey, completed: false, month: activeMonth };
                    saveProgress();
                    renderCalendars();
                    hideAssignmentModal();
                };
                assignmentOptionsEl.appendChild(optionBtn);
            });
        }
        
        assignmentModal.classList.add('open');
        assignmentModal.querySelector('.modal-content').classList.add('open');
        document.body.style.overflow = 'hidden';
    }
    
    function showClearAllConfirmation() {
        assignmentTitle.textContent = "¿Borrar Todo el Progreso?";
        assignmentDateEl.textContent = "Esta acción eliminará todas tus marcas y la fecha de inicio del plan. No se puede deshacer.";
        assignmentOptionsEl.innerHTML = '';
        
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'w-full p-3 bg-red-600 rounded-lg text-white font-semibold hover:bg-red-500 transition-colors';
        confirmBtn.textContent = "Sí, Limpiar Todo";
        confirmBtn.onclick = () => {
            completedDays = {};
            localStorage.removeItem('workoutStartDate');
            saveProgress();
            renderCalendars();
            hideAssignmentModal();
        };
        assignmentOptionsEl.appendChild(confirmBtn);

        deleteAssignmentBtn.style.display = 'none';
        assignmentModal.classList.add('open');
        assignmentModal.querySelector('.modal-content').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function updateAnalytics(){
        const totalWorkoutsEl = document.getElementById('total-workouts');
        const totalComplianceEl = document.getElementById('total-compliance');
        const perfectStreakEl = document.getElementById('perfect-streak');
        
        const completedOnly = Object.keys(completedDays).filter(date => completedDays[date] && completedDays[date].completed).sort();
        
        if(completedOnly.length === 0) {
            totalWorkoutsEl.textContent = '0';
            totalComplianceEl.textContent = '0%';
            perfectStreakEl.textContent = '0';
            if(complianceChart) {
                complianceChart.destroy();
                complianceChart = null;
            }
            return;
        }
        
        totalWorkoutsEl.textContent = completedOnly.length;
        
        const startDateString = localStorage.getItem('workoutStartDate') || completedOnly[0];
        const startDate = new Date(startDateString + 'T00:00:00');
        const firstDayOfWeek = new Date(startDate);
        firstDayOfWeek.setDate(startDate.getDate() - (startDate.getDay() === 0 ? 6 : startDate.getDay() - 1));

        const weeklyData = Array(12).fill(0);
        const weekLabels = Array.from({length: 12}, (_, i) => `S${i + 1}`);

        completedOnly.forEach(dayStr => {
            const day = new Date(dayStr + 'T00:00:00');
            const weekIndex = Math.floor((day - firstDayOfWeek) / (1000 * 60 * 60 * 24 * 7));
            if(weekIndex >= 0 && weekIndex < 12) {
                weeklyData[weekIndex]++;
            }
        });
        
        const today = new Date();
        const weeksPassed = Math.ceil(Math.max(1, (today - firstDayOfWeek) / (1000 * 60 * 60 * 24 * 7)));
        const possibleWorkouts = weeksPassed * 3;
        const compliance = possibleWorkouts > 0 ? Math.min(100, (completedOnly.length / possibleWorkouts) * 100).toFixed(0) : 0;
        totalComplianceEl.textContent = `${compliance}%`;
        
        let currentStreak = 0;
        let streakEnded = false;
        for(let i = weeksPassed - 1; i >= 0; i--){
             if(weeklyData[i] >= 3 && !streakEnded) {
                 currentStreak++;
             } else if (weeklyData[i] < 3) {
                 streakEnded = true; 
             }
        }
        perfectStreakEl.textContent = currentStreak;

        if (complianceChart) complianceChart.destroy();
        const ctx = document.getElementById('compliance-chart').getContext('2d');
        complianceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'Entrenamientos por Semana',
                    data: weeklyData,
                    backgroundColor: weeklyData.map(d => d >= 3 ? '#f97316' : 'rgba(251, 146, 60, 0.7)'),
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 4,
                        ticks: { stepSize: 1, color: '#9ca3af' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                         ticks: { color: '#9ca3af' },
                         grid: { display: false }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Initial Load
    loadProgress();
    renderCalendars(true);
    updateAnalytics();
    
    document.querySelectorAll('header, .sticky, #progress-section').forEach((el, index) => {
        el.classList.add('initial-hidden');
        setTimeout(() => {
            el.classList.add('fade-in');
        }, 100 * (index + 1));
    });
    renderPlan('1');

});
</script>
</body>
</html>
